worker_processes auto;

events { worker_connections 1024; }

http {
  # Hide NGINX version (cannot fully remove Server header without a module)
  server_tokens off;

  # Common proxy headers
  proxy_http_version 1.1;
  proxy_set_header Host              $host;
  proxy_set_header X-Real-IP         $remote_addr;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Connection        "";

  # ---- Upstreams: point to service DNS names inside Compose ----
  upstream inventory_service {
    server inventory-service:8081;
    # add more "server host:port;" lines if you run multiple replicas
  }
  upstream order_service {
    server order-service:8082;
  }

  server {
    listen 8080;
    server_name _;

    # Strip upstream "Server" header (NGINX will still send "Server: nginx"; see note)
    proxy_hide_header Server;

    # Health
    location = /healthz { return 200 "ok\n"; }

    # ---------- /api/inventory/** ----------
    location ^~ /api/inventory/ {
      # Best-effort remove of request header (clears value; cannot delete header in OSS NGINX)
      #proxy_set_header X-Api-Key "";

      # Keep the full original URI (no path rewrite)
      proxy_pass http://inventory_service;
    }

    # ---------- /api/order/** ----------
    location ^~ /api/order/ {
      proxy_set_header X-Api-Key "";
      proxy_pass http://order_service;
    }

    # Sensible timeouts/buffering
    proxy_connect_timeout 5s;
    proxy_send_timeout    60s;
    proxy_read_timeout    60s;
    proxy_buffering       on;
  }
}